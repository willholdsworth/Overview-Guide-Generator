<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCT OVERVIEW GUIDE GENERATOR</title>
 <style>
body {
    font-family: Open Sans, sans-serif;
    margin: 0;
    padding: 20px;
}

.container {
    width: calc(297mm - 40px);
    margin: 0 auto;
}

textarea {
    width: 100%;
    height: 100px;
    margin-bottom: 20px;
}

.a4-container {
    width: 100%;
    height: 210mm;
    border: 1px solid #000;
    padding: 20px;
    box-sizing: border-box;
    position: relative;
    page-break-after: always;
    margin-bottom: 20px;
}

.logo {
    width: 100px;
    position: absolute;
    top: 20px;
    left: 20px;
}

.title {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    white-space: nowrap;
    font-weight: bold;
    letter-spacing: 0.05rem;
}

.contact-info {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: right;
    font-size: 8pt;
}

.table-wrapper {
    position: absolute;
    top: 80px;
    left: 20px;
    right: 20px;
    bottom: 70px;
    display: flex;
    justify-content: center;
    overflow: hidden;
    border-top: 1px solid black;
    border-bottom: 1px solid black;
}

table {
    width: 100%;
    height: 100%;
    border-collapse: collapse;
    margin: 0;
    table-layout: fixed;
}

table, th, td {
    border-right: 1px solid black;
    text-align: center;
}

th, td {
    padding: 2px;
    overflow: hidden;
}

th:last-child, td:last-child {
    border-right: none;
}

td:first-child, th {
    background-color: black;
    color: white;
}

th a {
    color: white;
}

td.specifications {
    background-color: black;
    color: white;
    text-transform: uppercase;
}

td img {
    display: block;
    margin: 0 auto;
    max-width: 100%;
    height: auto;
}

tr.grey-row {
    background-color: #f2f2f2;
}

tr.white-row {
    background-color: white;
}

.group-row th {
    background-color: #707070;
    color: white;
}

.group-row th:first-child {
    background-color: black;
    color: white;
}

.footer {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
    font-size: 8px;
}

.styled-button {
    padding: 5px 5px;
    margin: 1px;
    background-color: green;
    color: white;
    border: 2px solid white;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
}

.styled-button:active {
    background-color: grey;
}

.toggle-button {
    padding: 5px 5px;
    margin: 1px;
    background-color: #303030;
    color: white;
    border: 2px solid white;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
}

.toggle-button.active {
    background-color: lightgrey;
    color: black;
}

.button-container {
    margin-bottom: 20px;
}

td a {
    color: inherit;
    text-decoration: underline;
}

.cell-value {
    margin-bottom: 2px;
    line-height: 1.2;
}

.cell-value:last-child {
    margin-bottom: 0;
}

.cell-value strong {
    font-size: 1em;
    font-weight: lighter;
    color: #000;
    display: inline;
}

.checkbox-container {
    display: inline-block;
    margin-left: 10px;
    vertical-align: middle;
}

.progress-container {
    width: 100%;
    height: 20px;
    background-color: #f2f2f2;
    border-radius: 5px;
    margin-top: 10px;
    margin-bottom: 20px;
    display: none;
}

.progress-bar {
    height: 100%;
    background-color: #4CAF50;
    border-radius: 5px;
    width: 0%;
    transition: width 0.3s ease-in-out;
}

@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    body {
        margin: 0 !important;
        padding: 0 !important;
        font-family: Open Sans, sans-serif !important;
    }
    
    .container {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .container > h1,
    .container > textarea,
    .container > button,
    .container > .checkbox-container,
    .container > .progress-container,
    .container > .button-container {
        display: none !important;
    }
    
    .a4-container {
        width: 100% !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 20px !important;
        border: none !important;
        box-sizing: border-box !important;
        page-break-before: always;
        page-break-after: always;
        page-break-inside: avoid;
        position: relative !important;
        display: block !important;
    }
    
    .a4-container:first-of-type {
        page-break-before: avoid;
    }
    
    .a4-container:last-of-type {
        page-break-after: avoid;
    }
    
    .logo {
        position: absolute !important;
        top: 20px !important;
        left: 20px !important;
        width: 100px !important;
        display: block !important;
    }
    
    .title {
        position: absolute !important;
        top: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        text-align: center !important;
        font-weight: bold !important;
        letter-spacing: 0.05rem !important;
        display: block !important;
    }
    
    .contact-info {
        position: absolute !important;
        top: 20px !important;
        right: 20px !important;
        text-align: right !important;
        font-size: 8pt !important;
        display: block !important;
    }
    
    .table-wrapper {
        position: absolute !important;
        top: 80px !important;
        left: 20px !important;
        right: 20px !important;
        bottom: 70px !important;
        border-top: 1px solid black !important;
        border-bottom: 1px solid black !important;
        display: block !important;
        overflow: visible !important;
    }
    
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        table-layout: fixed !important;
        display: table !important;
    }
    
    thead {
        display: table-header-group !important;
    }
    
    tbody {
        display: table-row-group !important;
    }
    
    tr {
        display: table-row !important;
        page-break-inside: avoid;
    }
    
    tr[style*="display: none"] {
        display: none !important;
    }
    
    th, td {
        display: table-cell !important;
        padding: 2px !important;
        border-right: 1px solid black !important;
        text-align: center !important;
        overflow: hidden !important;
    }
    
    th:last-child, td:last-child {
        border-right: none !important;
    }
    
    td:first-child, th {
        background-color: black !important;
        color: white !important;
    }
    
    th a {
        color: white !important;
        text-decoration: underline !important;
    }
    
    .group-row th {
        background-color: #707070 !important;
        color: white !important;
    }
    
    .group-row th:first-child {
        background-color: black !important;
        color: white !important;
    }
    
    .grey-row {
        background-color: #f2f2f2 !important;
    }
    
    .white-row {
        background-color: white !important;
    }
    
    td img {
        display: block !important;
        margin: 0 auto !important;
        max-width: 100% !important;
        height: auto !important;
    }
    
    .footer {
        position: absolute !important;
        bottom: 20px !important;
        left: 20px !important;
        right: 20px !important;
        text-align: center !important;
        font-size: 8px !important;
        display: block !important;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>PRODUCT OVERVIEW GUIDE GENERATOR</h1>
        <textarea id="urlInput" placeholder="Paste URLs here, one per line">
TITLE - ARTICULATING WALL MOUNT GUIDE
https://www.futureautomation.co.uk/Product/Details/PS32
https://www.futureautomation.co.uk/Product/Details/PS40
https://www.futureautomation.co.uk/Product/Details/PS55
https://www.futureautomation.co.uk/Product/Details/PS65
https://www.futureautomation.co.uk/Product/Details/PS80
SPLIT - https://www.futureautomation.co.uk/Product/Details/DA
https://www.futureautomation.co.uk/Product/Details/FSA1
https://www.futureautomation.co.uk/Product/Details/FSA2

TITLE - OUTDOOR / MARINE ARTICULATING WALL MOUNT GUIDE
https://www.futureautomation.co.uk/Product/Details/IP-PS40
https://www.futureautomation.co.uk/Product/Details/IP-PS55
https://www.futureautomation.co.uk/Product/Details/IP-PS65
https://www.futureautomation.co.uk/Product/Details/IP-PS80
SPLIT - https://www.futureautomation.co.uk/Product/Details/PS-M
https://www.futureautomation.co.uk/Product/Details/M-FSA2
https://www.futureautomation.co.uk/Product/Details/MSH
SPLIT - https://www.futureautomation.co.uk/Product/Details/IP-DA

TITLE - FIXED POSITION WALL MOUNT GUIDE
https://www.futureautomation.co.uk/Product/Details/FB49
https://www.futureautomation.co.uk/Product/Details/FB22
https://www.futureautomation.co.uk/Product/Details/FB80
https://www.futureautomation.co.uk/Product/Details/V74-MO
https://www.futureautomation.co.uk/Product/Details/M-V74
https://www.futureautomation.co.uk/Product/Details/MAG-V2

TITLE - MARINE PULL & SWIVEL BRACKET GUIDE
https://www.futureautomation.co.uk/Product/Details/PS3219-2S-M
https://www.futureautomation.co.uk/Product/Details/PS4026-2S-M
https://www.futureautomation.co.uk/Product/Details/PS5531-2S-M
https://www.futureautomation.co.uk/Product/Details/PS8034-M

TITLE - WALL BOX GUIDE
GROUP - UNIVERSAL WALL BOXES
https://www.futureautomation.co.uk/Product/Details/WB
https://www.futureautomation.co.uk/Product/Details/UB
GROUP - PRODUCT SPECIFIC WALL BOXES
https://www.futureautomation.co.uk/Product/Details/WB80
https://www.futureautomation.co.uk/Product/Details/WB-PSE90
https://www.futureautomation.co.uk/Product/Details/WB-QA2
https://www.futureautomation.co.uk/Product/Details/WB-DA
https://www.futureautomation.co.uk/Product/Details/WB-EAD
https://www.futureautomation.co.uk/Product/Details/WB-EAD-S
https://www.futureautomation.co.uk/Product/Details/WB-EAL
https://www.futureautomation.co.uk/Product/Details/WB-FSA1
https://www.futureautomation.co.uk/Product/Details/WB-FSA2
GROUP - WALL BOX BLANKING PLATES
https://www.futureautomation.co.uk/Product/Details/WB-BCP
https://www.futureautomation.co.uk/Product/Details/WB-VCP
https://www.futureautomation.co.uk/Product/Details/WB-2S-BCP

TITLE - MOTORISED ARTICULATING WALL MOUNT GUIDE
GROUP - INDOOR
https://www.futureautomation.co.uk/Product/Details/FSE90
https://www.futureautomation.co.uk/Product/Details/PSE90
https://www.futureautomation.co.uk/Product/Details/HSE90
https://www.futureautomation.co.uk/Product/Details/QA2
https://www.futureautomation.co.uk/Product/Details/QA2-60
https://www.futureautomation.co.uk/Product/Details/HQA2
https://www.futureautomation.co.uk/Product/Details/IW-PTL
GROUP - MARINE INDOOR
https://www.futureautomation.co.uk/Product/Details/QA2-M
https://www.futureautomation.co.uk/Product/Details/QA2-60-M
https://www.futureautomation.co.uk/Product/Details/M-PSE90
GROUP - OUTDOOR / MARINE OUTDOOR
https://www.futureautomation.co.uk/Product/Details/QA2-MO
https://www.futureautomation.co.uk/Product/Details/QA2-60-MO

TITLE - SLIDING PANEL SYSTEM GUIDE
https://www.futureautomation.co.uk/Product/Details/SPS-V
https://www.futureautomation.co.uk/Product/Details/SPS-VS
https://www.futureautomation.co.uk/Product/Details/SPS-HZ
https://www.futureautomation.co.uk/Product/Details/SPS-HZS
https://www.futureautomation.co.uk/Product/Details/SPS-V-QA
https://www.futureautomation.co.uk/Product/Details/SPS-VS-QA
https://www.futureautomation.co.uk/Product/Details/SPS-HZ-QA
https://www.futureautomation.co.uk/Product/Details/SPS-HZS-QA

TITLE - CEILING MOUNT GUIDE
https://www.futureautomation.co.uk/Product/Details/CM
https://www.futureautomation.co.uk/Product/Details/CM-BLK
https://www.futureautomation.co.uk/Product/Details/CME
https://www.futureautomation.co.uk/Product/Details/CM-MO

TITLE - FIREPLACE DISPLAY MOUNT GUIDE
https://www.futureautomation.co.uk/Product/Details/EAD
https://www.futureautomation.co.uk/Product/Details/EAD-S
https://www.futureautomation.co.uk/Product/Details/EAL
https://www.futureautomation.co.uk/Product/Details/WB-EAD
https://www.futureautomation.co.uk/Product/Details/WB-EAD-S
https://www.futureautomation.co.uk/Product/Details/WB-EAL

TITLE - MOTORISED DISPLAY LIFTING GUIDE
https://www.futureautomation.co.uk/Product/Details/LSL
https://www.futureautomation.co.uk/Product/Details/LSL-EFA
https://www.futureautomation.co.uk/Product/Details/LSM
https://www.futureautomation.co.uk/Product/Details/LSM-EFA
https://www.futureautomation.co.uk/Product/Details/LSH
https://www.futureautomation.co.uk/Product/Details/LSM-TU
https://www.futureautomation.co.uk/Product/Details/AL675
https://www.futureautomation.co.uk/Product/Details/AL965
https://www.futureautomation.co.uk/Product/Details/TSL
https://www.futureautomation.co.uk/Product/Details/TSLH
https://www.futureautomation.co.uk/Product/Details/TSL-MO
https://www.futureautomation.co.uk/Product/Details/LSH-MO
https://www.futureautomation.co.uk/Product/Details/PL
https://www.futureautomation.co.uk/Product/Details/ML
https://www.futureautomation.co.uk/Product/Details/SRV-SBL

TITLE - CEILING HINGE RANGE GUIDE
GROUP - INDOOR RESIDENTIAL
https://www.futureautomation.co.uk/Product/Details/CHR
https://www.futureautomation.co.uk/Product/Details/CHRS
https://www.futureautomation.co.uk/Product/Details/CHRT
https://www.futureautomation.co.uk/Product/Details/CHRST
GROUP - INDOOR MARINE
https://www.futureautomation.co.uk/Product/Details/CHR-M
https://www.futureautomation.co.uk/Product/Details/CHRS-M
https://www.futureautomation.co.uk/Product/Details/CHR-C-M
https://www.futureautomation.co.uk/Product/Details/CHR-M-DDP
https://www.futureautomation.co.uk/Product/Details/CHRS-M-DDP
GROUP - OUTDOOR MARINE
https://www.futureautomation.co.uk/Product/Details/CHR-MO
https://www.futureautomation.co.uk/Product/Details/CHR-MO-DDP
https://www.futureautomation.co.uk/Product/Details/CHRS-MO
https://www.futureautomation.co.uk/Product/Details/CHRS-MO-DDP
        
        </textarea>
        <button id="generateButton" class='styled-button'>GENERATE PAGE ></button>
        <button type="button" onclick="printPage()" class='styled-button'>EXPORT AS PDF</button>
        <div class="checkbox-container">
            <input type="checkbox" id="splitProductCodes" name="splitProductCodes">
            <label for="splitProductCodes">Split All Product Codes</label>
        </div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="button-container" id="buttonContainer"></div>
        <div id="pagesContainer"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
const corsProxyAPI = 'https://api.codetabs.com/v1/proxy?quest=';
const delayBetweenRequests = 220;
const allSpecifications = {};
let previousUrls = [];
let toggleStates = {};
let lastUrlInput = '';

function printPage() {
    window.print();
}

async function fetchHTML(url) {
    try {
        const response = await fetch(`${corsProxyAPI}${encodeURIComponent(url)}`);
        const contentType = response.headers.get('Content-Type');
        if (contentType.includes('application/json')) {
            return (await response.json()).contents;
        }
        if (contentType.includes('text/html') || contentType.includes('text/plain')) {
            return await response.text();
        }
        return '';
    } catch (error) {
        console.error(`Error fetching URL ${url}:`, error);
        return '';
    }
}

function cleanTechnicalSpecificationTable(table) {
    Array.from(table.querySelectorAll('tr')).forEach(row => {
        if (row.querySelectorAll('button').length > 0) row.remove();
        Array.from(row.cells).forEach(cell => {
            const images = cell.querySelectorAll('img');
            if (images.length > 0) {
                images.forEach(image => image.remove());
                cell.querySelectorAll('strong').forEach(tag => tag.remove());
                if (cell.textContent.trim() === '' && !cell.querySelector('a')) cell.remove();
            }
        });
        if (row.cells.length === 0 || Array.from(row.cells).every(cell => cell.textContent.trim() === '' && !cell.querySelector('a'))) row.remove();
    });
}

async function scrapeProductData(url) {
    const html = await fetchHTML(url);
    if (!html) return { productName: 'Unknown Product', productImage: '', specifications: {}, subcodes: [], url };
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const productName = doc.querySelector('#PageProductID')?.textContent.trim() || 'Unknown Product';
    const productImage = doc.querySelector('img[src^="https://d2oo5quzpsdib.cloudfront.net/Website/Product/Main/"]')?.src || '';
    const specifications = {};
    const subcodes = [];
    
    const heading = Array.from(doc.querySelectorAll('h2')).find(h2 => h2.textContent.includes('TECHNICAL SPECIFICATION'));
    if (heading && heading.nextElementSibling) {
        const table = heading.nextElementSibling.querySelector('table');
        if (table) {
            cleanTechnicalSpecificationTable(table);
            let headerCodes = [];
            const headerRow = table.querySelector('tr');
            if (headerRow) {
                headerCodes = Array.from(headerRow.querySelectorAll('th, td')).slice(1).map(cell => cell.textContent.trim());
            }
            
            Array.from(table.querySelectorAll('tr')).forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td, th');
                if (cells.length > 1) {
                    const key = cells[0].textContent.trim();
                    const values = Array.from(cells).slice(1).map(cell => cell.innerHTML.trim());
                    const codes = headerCodes.length > 0 ? headerCodes : values.map((_, i) => `${productName}${i + 1}`);
                    
                    specifications[key] = values.map((value, index) => ({
                        value: value,
                        subcode: codes[index] || productName
                    }));
                    
                    if (key.toUpperCase() === 'PRODUCT CODE') {
                        codes.forEach(code => {
                            if (code && !subcodes.includes(code)) subcodes.push(code);
                        });
                    }
                }
            });
        }
    }
    return { productName, productImage, specifications, subcodes, url };
}

function simplifySizes(values, spec, splitProductCodes) {
    const specUpper = spec.toUpperCase();
    return values.map(item => {
        if (['TECH SHEET', 'SELL SHEET', 'CAD'].includes(specUpper)) return item;
        if ((specUpper.includes('MAX') || specUpper.includes('MAXIMUM')) && !splitProductCodes) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = item.value;
            return { value: tempDiv.textContent.trim().split(', ').pop().trim(), subcode: item.subcode };
        }
        return item;
    });
}

function selectCompactValue(values, spec, productName) {
    const specUpper = spec.toUpperCase();
    if (specUpper.includes('MAX') || specUpper.includes('MAX.') || specUpper.includes('MAXIMUM') || 
        specUpper.includes('SHIPPING') || specUpper.includes('SHIP') || specUpper.includes('WEIGHT')) {
        const lastValue = values[values.length - 1]?.value || 'N/A';
        return [{ value: lastValue, subcode: productName }];
    }
    return values;
}

function adjustTitleFontSize(titleElement, text) {
    const minFontSize = 12;
    const maxFontSize = 20;
    const baseLength = 20;
    const scaleFactor = Math.min(1, baseLength / text.length);
    const fontSize = minFontSize + (maxFontSize - minFontSize) * scaleFactor;
    titleElement.style.fontSize = `${fontSize}pt`;
}

function updateRowColors(table) {
    const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(tr => tr.style.display !== 'none');
    visibleRows.forEach((row, index) => {
        row.classList.remove('grey-row', 'white-row');
        if (index % 2 === 0) {
            row.classList.add('white-row');
        } else {
            row.classList.add('grey-row');
        }
    });
}

async function updateTables() {
    const urlInput = document.getElementById('urlInput').value;
    const splitProductCodes = document.getElementById('splitProductCodes').checked;
    const lines = urlInput.split('\n').map(line => line.trim()).filter(line => line !== '');
    
    const pages = [];
    let currentPage = null;
    
    // Parse input lines to create pages
    lines.forEach(line => {
        if (line.startsWith('TITLE -')) {
            // Save the previous page if it exists
            if (currentPage) {
                pages.push(currentPage);
            }
            // Start a new page, even if title is empty
            currentPage = {
                title: line.replace('TITLE -', '').trim(), // Allow empty title
                groups: [],
                urls: []
            };
        } else if (line.startsWith('GROUP - ')) {
            if (!currentPage) {
                // If no TITLE yet, create a default page
                currentPage = { title: '', groups: [], urls: [] };
            }
            currentPage.groups.push({
                name: line.replace('GROUP - ', '').trim(),
                urls: []
            });
        } else if (line.startsWith('http') || line.startsWith('SPLIT - ')) {
            if (!currentPage) {
                // If no TITLE yet, create a default page
                currentPage = { title: '', groups: [], urls: [] };
            }
            const url = line.startsWith('SPLIT - ') ? line.replace('SPLIT - ', '').trim() : line;
            const shouldSplit = line.startsWith('SPLIT - ') ? true : splitProductCodes;
            const currentGroup = currentPage.groups.length > 0 ? currentPage.groups[currentPage.groups.length - 1] : null;
            if (currentGroup) {
                currentGroup.urls.push({ url, shouldSplit });
            } else {
                currentPage.urls.push({ url, shouldSplit });
            }
        }
    });
    
    // Push the last page if it exists
    if (currentPage) {
        pages.push(currentPage);
    }
    
    // If no pages were created, ensure at least one page exists
    if (pages.length === 0) {
        pages.push({ title: '', groups: [], urls: [] });
    }

    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    
    const pagesContainer = document.getElementById('pagesContainer');
    const buttonContainer = document.getElementById('buttonContainer');
    pagesContainer.innerHTML = '';
    buttonContainer.innerHTML = '';
    
    const totalUrls = pages.reduce((sum, page) => sum + (page.groups.flatMap(g => g.urls).length + page.urls.length), 0);
    let processedUrls = 0;
    
    for (let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
        const page = pages[pageIndex];
        const productDataList = [];
        const effectiveUrls = page.groups.length > 0 ? page.groups.flatMap(g => g.urls) : page.urls;
        
        for (const { url, shouldSplit } of effectiveUrls) {
            let productData = await scrapeProductData(url);
            productData.shouldSplit = shouldSplit;
            productDataList.push(productData);
            processedUrls++;
            const progressPercentage = (processedUrls / totalUrls) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            await new Promise(resolve => setTimeout(resolve, delayBetweenRequests));
        }
        
        const a4Container = document.createElement('div');
        a4Container.classList.add('a4-container');
        a4Container.innerHTML = `
            <img src="https://s3.eu-west-1.amazonaws.com/cdn.futureautomation.co.uk/Files/Logo+Centered+-+Black.svg" alt="Logo" class="logo">
            <div class="title" id="pageTitle${pageIndex}">${page.title || ''}</div>
            <div class="contact-info">
                <b>UK</b> 01438 833 577<br>
                <b>USA</b> 603.742.9181<br>
                info@futureautomation.net
            </div>
            <div class="table-wrapper" id="tableWrapper${pageIndex}">
                <table id="infoTable${pageIndex}">
                    <thead><tr><th>SPECIFICATION</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="footer">
                www.<b>FUTUREAUTOMATION</b>.net<br>
                Future Sound and Vision Ltd. Registered in England. Company Number: 05124376.<br>
                Registered Office: Unit 2 Kimpton Enterprise Park, Claggy Road, Kimpton, Herts, SG4 8HP
            </div>
        `;
        pagesContainer.appendChild(a4Container);
        
        const titleElement = document.getElementById(`pageTitle${pageIndex}`);
        if (page.title) adjustTitleFontSize(titleElement, page.title);
        else titleElement.style.fontSize = '12pt';
        
        const tbody = document.getElementById(`infoTable${pageIndex}`).querySelector('tbody');
        const thead = document.getElementById(`infoTable${pageIndex}`).querySelector('thead');
        
        let expandedProductDataList = [];
        let productCodeToUrl = {};
        productDataList.forEach(product => {
            const useSplit = product.shouldSplit;
            if (useSplit && product.subcodes.length > 1) {
                product.subcodes.forEach(subcode => {
                    const newProduct = { ...product, subcodes: [subcode], productName: subcode };
                    const newSpecifications = {};
                    Object.keys(product.specifications).forEach(spec => {
                        const values = product.specifications[spec] || [];
                        const matchingValue = values.find(v => v.subcode === subcode);
                        newSpecifications[spec] = matchingValue ? [matchingValue] : [];
                    });
                    newProduct.specifications = newSpecifications;
                    newProduct.url = product.url;
                    expandedProductDataList.push(newProduct);
                    productCodeToUrl[subcode] = product.url;
                });
            } else {
                expandedProductDataList.push(product);
                productCodeToUrl[product.subcodes[0] || product.productName] = product.url;
            }
        });

        expandedProductDataList.forEach(product => {
            const th = document.createElement('th');
            const a = document.createElement('a');
            const productCode = product.shouldSplit ? (product.subcodes[0] || product.productName) : product.productName;
            a.href = productCodeToUrl[productCode] || product.url;
            a.textContent = productCode;
            th.appendChild(a);
            thead.children[0].appendChild(th);
        });
        
        if (page.groups.length > 0) {
            const groupRow = document.createElement('tr');
            groupRow.classList.add('group-row');
            const emptyTh = document.createElement('th');
            groupRow.appendChild(emptyTh);
            page.groups.forEach(group => {
                let groupProductCount = 0;
                group.urls.forEach(({ url }) => {
                    const product = productDataList.find(p => p.url === url);
                    if (product && product.shouldSplit) {
                        groupProductCount += product.subcodes.length;
                    } else {
                        groupProductCount += 1;
                    }
                });
                const th = document.createElement('th');
                th.textContent = group.name;
                th.colSpan = groupProductCount;
                groupRow.appendChild(th);
            });
            thead.insertBefore(groupRow, thead.children[0]);
        }
        
        const imageRow = document.createElement('tr');
        const imageCell = document.createElement('td');
        imageCell.textContent = 'PRODUCT IMAGE';
        imageRow.appendChild(imageCell);
        expandedProductDataList.forEach(product => {
            const imgCell = document.createElement('td');
            const img = document.createElement('img');
            img.src = product.productImage;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            imgCell.appendChild(img);
            imageRow.appendChild(imgCell);
        });
        tbody.appendChild(imageRow);
        
        const firstImageCell = imageRow.querySelector('td:nth-child(2)');
        if (firstImageCell) {
            const cellWidth = firstImageCell.offsetWidth;
            imageRow.style.height = `${cellWidth}px`;
            imageRow.querySelectorAll('td').forEach(cell => cell.style.height = `${cellWidth}px`);
        }
        
        const allSpecs = new Set();
        expandedProductDataList.forEach(product => {
            Object.keys(product.specifications).forEach(spec => allSpecs.add(spec));
        });
        
        const rows = [];
        let techSheetRow = null;
        const buttons = [];
        let techSheetButton = null;
        
		const defaultHiddenSpecs = ['DOWNLOADS', 'EXAMPLE TECHNICAL SHEETS', 'SHIPPING DIMENSIONS', 'VIDEO INSTRUCTIONS', 'SHIPPING WEIGHT', 'WHAT\'S INCLUDED'];

		allSpecs.forEach(spec => {
			const specUpper = spec.toUpperCase();
			if (["CAD", "INSTRUCTIONS", "SELL SHEET"].includes(specUpper)) return;

			const tr = document.createElement('tr');
			const tdSpec = document.createElement('td');
			tdSpec.textContent = spec;
			tr.appendChild(tdSpec);

			if (defaultHiddenSpecs.includes(specUpper)) {
				tr.style.display = 'none';
			}

			expandedProductDataList.forEach((product, index) => {
				const tdValue = document.createElement('td');
				let values = product.specifications[spec] || [];
				if (!product.shouldSplit) {
					values = selectCompactValue(values, spec, product.productName);
				}
				values = simplifySizes(values, spec, product.shouldSplit);
				
				if (values.length === 0) {
					tdValue.innerHTML = 'N/A';
				} else {
					if (product.shouldSplit) {
						tdValue.innerHTML = `<div class="cell-value">${values[0]?.value || 'N/A'}</div>`;
					} else {
						const valueGroups = {};
						values.forEach(item => {
							const valueKey = item.value;
							if (!valueGroups[valueKey]) {
								valueGroups[valueKey] = [];
							}
							valueGroups[valueKey].push(item.subcode);
						});

						const uniqueValues = Object.keys(valueGroups);
						const isSingleValue = uniqueValues.length === 1;

						if (specUpper === 'TECHNICAL SHEET' || specUpper === 'TECH SHEET') {
							tdValue.innerHTML = values.map(item => item.value).join(' ');
						} else if (specUpper === 'PRODUCT CODE') {
							tdValue.innerHTML = `<div class="cell-value">${values.map(item => item.subcode).join(', ')}</div>`;
						} else if (isSingleValue) {
							tdValue.innerHTML = `<div class="cell-value">${uniqueValues[0]}</div>`;
						} else {
							const formattedValues = Object.entries(valueGroups).map(([value, subcodes]) => {
								return `<div class="cell-value"><strong>${subcodes.join(', ')}</strong></div><div class="cell-value">${value}</div>`;
							});
							tdValue.innerHTML = formattedValues.join('');
						}
					}
				}
				
				tr.appendChild(tdValue);
			});

			if (specUpper === 'TECH SHEET' || specUpper === 'TECHNICAL SHEET') {
				techSheetRow = tr;
			} else {
				rows.push(tr);
			}

			const button = document.createElement('button');
			button.textContent = `${spec}`;
			button.classList.add('toggle-button');
			button.dataset.pageIndex = pageIndex;

			if (defaultHiddenSpecs.includes(specUpper)) {
				button.classList.add('active');
			}

			button.onclick = () => {
				tr.style.display = tr.style.display === 'none' ? '' : 'none';
				button.classList.toggle('active');
				adjustFontSizeBasedOnTableContent(pageIndex);
				updateRowColors(document.getElementById(`infoTable${pageIndex}`));
			};

			if (specUpper === 'TECH SHEET' || specUpper === 'TECHNICAL SHEET') {
				techSheetButton = button;
			} else {
				buttons.push(button);
			}
		});
        
        rows.forEach(row => tbody.appendChild(row));
        
        if (techSheetRow) tbody.appendChild(techSheetRow);
        
        buttons.forEach(button => buttonContainer.appendChild(button));
        
        if (techSheetButton) buttonContainer.appendChild(techSheetButton);
        
        updateRowColors(document.getElementById(`infoTable${pageIndex}`));
        adjustFontSizeBasedOnTableContent(pageIndex);
    }
    
    progressContainer.style.display = 'none';
    document.getElementById('generateButton').disabled = true;
}

function adjustFontSizeBasedOnTableContent(pageIndex) {
    const table = document.getElementById(`infoTable${pageIndex}`);
    const tableWrapper = document.getElementById(`tableWrapper${pageIndex}`);
    if (!table || !tableWrapper) return;
    const visibleRows = Array.from(table.querySelectorAll('tr')).filter(tr => tr.style.display !== 'none');
    if (visibleRows.length === 0) return;
    const cells = table.querySelectorAll('th, td');
    const maxFontSize = 12;
    const minFontSize = 3;
    let optimalFontSize = maxFontSize;
    cells.forEach(cell => cell.style.fontSize = '');
    visibleRows.forEach(row => {
        const visibleCells = Array.from(row.querySelectorAll('th, td')).filter(cell => {
            const style = window.getComputedStyle(cell);
            return cell.style.display !== 'none' && style.visibility !== 'hidden';
        });
        visibleCells.forEach(cell => {
            const computedStyle = window.getComputedStyle(cell);
            const paddingTop = parseFloat(computedStyle.paddingTop);
            const paddingBottom = parseFloat(computedStyle.paddingBottom);
            const paddingLeft = parseFloat(computedStyle.paddingLeft);
            const paddingRight = parseFloat(computedStyle.paddingRight);
            const cellHeight = cell.clientHeight - paddingTop - paddingBottom;
            const cellWidth = cell.clientWidth - paddingLeft - paddingRight;
            if (cellHeight <= 0 || cellWidth <= 0 || !cell.textContent.trim()) return;
            cell.style.fontSize = `${maxFontSize}px`;
            const textHeight = cell.scrollHeight;
            const textWidth = cell.scrollWidth;
            const heightRatio = cellHeight / textHeight;
            const widthRatio = cellWidth / textWidth;
            const scaleFactor = Math.min(heightRatio, widthRatio);
            let tdFontHeight = Math.floor(maxFontSize * scaleFactor);
            tdFontHeight = Math.max(minFontSize, Math.min(tdFontHeight, maxFontSize));
            optimalFontSize = Math.min(optimalFontSize, tdFontHeight);
        });
    });
    cells.forEach(cell => cell.style.fontSize = `${optimalFontSize}px`);
    const visibleTableHeight = visibleRows.reduce((sum, row) => sum + row.offsetHeight, 0);
    const wrapperHeight = tableWrapper.clientHeight;
    if (visibleTableHeight > wrapperHeight) {
        const heightRatio = wrapperHeight / visibleTableHeight;
        const dampedRatio = Math.max(0.71, heightRatio); 
        optimalFontSize = Math.floor(optimalFontSize * dampedRatio);
        optimalFontSize = Math.max(minFontSize, Math.min(optimalFontSize, maxFontSize));
        cells.forEach(cell => cell.style.fontSize = `${optimalFontSize}px`);
    }
    const groupRow = table.querySelector('.group-row');
    const specRow = table.querySelector('thead tr:not(.group-row)');
    if (groupRow && specRow) {
        groupRow.style.height = `${specRow.offsetHeight}px`;
    }
    updateRowColors(table);
}

function setupTableObservers() {
    const tables = document.querySelectorAll('table[id^="infoTable"]');
    tables.forEach((table, index) => {
        const observer = new MutationObserver(() => adjustFontSizeBasedOnTableContent(index));
        observer.observe(table, { childList: true, subtree: true });
    });
}

document.addEventListener('DOMContentLoaded', () => {
    setupTableObservers();
    document.getElementById('generateButton').addEventListener('click', () => {
        updateTables();
        lastUrlInput = document.getElementById('urlInput').value;
        document.getElementById('generateButton').disabled = true;
    });
    document.getElementById('urlInput').addEventListener('input', () => {
        const currentUrlInput = document.getElementById('urlInput').value;
        document.getElementById('generateButton').disabled = currentUrlInput === lastUrlInput;
    });
    document.getElementById('splitProductCodes').addEventListener('change', () => {
        document.getElementById('generateButton').disabled = false;
    });
});
</script>
</body>
</html>
